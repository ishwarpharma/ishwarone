<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ishwar Pharma Order Form</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f1f7ff;
      margin: 0;
      padding: 10px;
    }

    .container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    h2 {
      text-align: center;
      color: #0077cc;
    }

    .input-group {
      margin-bottom: 15px;
    }

    input, select, button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    button {
      background: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
    }

    .hidden {
      display: none;
    }

    .search-results div {
      padding: 5px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .search-results div:hover {
      background: #e1f0ff;
    }

    .cart-item {
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      padding: 5px;
      border-bottom: 1px solid #ddd;
    }

    .cart-item span {
      flex: 1;
    }

    .material-icons {
      font-size: 18px;
      cursor: pointer;
      margin-left: 5px;
    }
  </style>
</head>

<body>
  <div class="container" id="welcome-screen">
    <h2>🧾 Ishwar Pharma Order Form</h2>
    <div class="input-group">
      <label>Date</label>
      <input type="date" id="order-date">
    </div>
    <div class="input-group">
      <label>👨‍💼 Salesman Name</label>
      <input type="text" id="salesman-name">
    </div>
    <div class="input-group">
      <label>🏬 Party Name</label>
      <input type="text" id="party-name">
    </div>
    <div class="input-group">
      <label>📍 Place</label>
      <input type="text" id="place-name">
    </div>
    <button onclick="startOrdering()">🚀 Start Ordering</button>
  </div>

  <div class="container hidden" id="order-screen">
    <div class="input-group">
      <label>🔍 Search Product</label>
      <input type="text" id="search-input" placeholder="Type brand and company">
      <div class="search-results" id="search-results"></div>
    </div>

    <div class="input-group hidden" id="details-form">
      <label>Enter Details</label>
      <input type="number" id="qty" placeholder="Quantity" inputmode="numeric">
      <input type="number" id="disc" placeholder="Discount %" inputmode="decimal">
      <input type="number" id="splrate" placeholder="Special Rate" inputmode="decimal">
      <button onclick="addToCart()">➕ Add to Cart</button>
    </div>

    <div id="cart-list"></div>
    <button onclick="finaliseOrder()">📄 Finalise Order & Download PDF</button>
  </div>

  <script>
    const cart = [];
    let stockData = [];
    let selectedProduct = null;

    document.getElementById("order-date").valueAsDate = new Date();

    function startOrdering() {
      document.getElementById('welcome-screen').classList.add('hidden');
      document.getElementById('order-screen').classList.remove('hidden');
    }

    function addToCart() {
      const qty = document.getElementById('qty').value;
      const disc = document.getElementById('disc').value;
      const splrate = document.getElementById('splrate').value;
      if (selectedProduct && qty > 0) {
        cart.push({
          ...selectedProduct,
          qty,
          disc,
          splrate
        });
        renderCart();
        document.getElementById('details-form').classList.add('hidden');
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
      }
    }

    function renderCart() {
      const list = cart.map((item, i) => `
        <div class="cart-item">
          <span>${i + 1}. ${item.brand} (${item.company})</span>
          <span>${item.qty} × ${item.rate}</span>
          <span>Disc: ${item.disc}%</span>
          <span>SR: ${item.splrate}</span>
          <span><i class="material-icons" onclick="deleteItem(${i})">delete</i></span>
        </div>`).join('');
      document.getElementById('cart-list').innerHTML = list;
    }

    function deleteItem(index) {
      cart.splice(index, 1);
      renderCart();
    }

    function finaliseOrder() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const date = document.getElementById("order-date").value;
      const salesman = document.getElementById("salesman-name").value;
      const party = document.getElementById("party-name").value;
      const place = document.getElementById("place-name").value;

      doc.text("Ishwar Pharma Order", 14, 14);
      doc.text(`Date: ${date}`, 14, 22);
      doc.text(`Salesman: ${salesman}`, 14, 30);
      doc.text(`Party: ${party}`, 14, 38);
      doc.text(`Place: ${place}`, 14, 46);

      const rows = cart.map((item, i) => [
        i + 1, item.brand, item.company, item.qty, item.rate, item.disc, item.splrate,
        (item.splrate ? item.qty * item.splrate : item.qty * item.rate).toFixed(2)
      ]);

      doc.autoTable({
        startY: 50,
        head: [["Sr", "Brand", "Company", "Qty", "Rate", "Disc%", "SplRate", "Amt"]],
        body: rows
      });

      const total = rows.reduce((sum, row) => sum + parseFloat(row[7]), 0);
      doc.text(`Total: ₹${total.toFixed(2)}`, 14, doc.lastAutoTable.finalY + 10);
      doc.save(`order_${party}_${date}.pdf`);
    }

    fetch("stock.xlsx")
      .then(res => res.arrayBuffer())
      .then(data => {
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        stockData = rows.slice(1).map(row => ({
          brand: row[1],
          rate: parseFloat(row[12]) || 0,
          mrp: parseFloat(row[10]) || 0,
          company: row[13]
        })).filter(item => item.brand && item.company);
      });

    document.getElementById("search-input").addEventListener("input", function () {
      const q = this.value.toLowerCase();
      const [brandPart, companyPart] = q.split(" ");
      const results = stockData.filter(item =>
        item.brand.toLowerCase().includes(brandPart || '') &&
        item.company.toLowerCase().includes(companyPart || '')
      );

      document.getElementById("search-results").innerHTML = results.map(item =>
        `<div onclick='selectItem(${JSON.stringify(JSON.stringify(item))})'>
           ${item.brand} (${item.company}) - ₹${item.rate} | MRP ₹${item.mrp}
         </div>`).join("");
    });

    function selectItem(json) {
      selectedProduct = JSON.parse(JSON.parse(json));
      document.getElementById("details-form").classList.remove("hidden");
    }
  </script>
</body>

</html>
