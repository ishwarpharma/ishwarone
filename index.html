<!DOCTYPE html>
<html lang="en">

<head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ishwar Pharma Order Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
      color: #333;
    }

    header {
      background-color: #1e90ff;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
    }

    main {
      padding: 1rem;
    }

    .screen {
      display: none;
    }

    .active {
      display: block;
    }

    input, button, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    button {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #218838;
    }

    .product-card {
      padding: 0.5rem;
      background-color: #fff;
      border: 1px solid #ddd;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .emoji {
      font-size: 1.2rem;
    }

    .cart-item-actions button {
      background: transparent;
      color: #007bff;
      border: none;
      font-size: 1rem;
    }

    .cart-item-actions button:hover {
      text-decoration: underline;
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row > div {
      flex: 1;
    }
  </style>
</head>

<body>
  <header>📝 Ishwar Pharma Order Form</header>
  <main>
    <div class="screen active" id="screen1">
      <label>Date:</label>
      <input type="text" id="date" readonly>
      <label>Salesman Name:</label>
      <input type="text" id="salesman">
      <label>Party Name:</label>
      <input type="text" id="party">
      <label>Place/District:</label>
      <input type="text" id="place">
      <button onclick="nextScreen()">🚀 Start Ordering</button>
    </div>

    <div class="screen" id="screen2">
      <label>🔍 Search Product:</label>
      <input type="text" id="search" oninput="filterProducts()" placeholder="Enter brand name and company name">
      <div id="suggestions"></div>

<div id="entryForm" style="display:none">
  <div id="rateInfo" style="font-weight:bold; margin-bottom:10px; color:#0055aa;"></div>
  <div class="row">
<div>
  <label>Qty</label>
  <input type="number" inputmode="decimal" id="qty">
  <select id="qtyType">
    <option value="Units">Units</option>
    <option value="Box">Box</option>
    <option value="Case">Case</option>
  </select>
</div>
    <div>
      <label>Discount %</label>
      <input type="number" inputmode="decimal" id="disc">
    </div>
    <div>
      <label>Special Rate</label>
      <input type="number" inputmode="decimal" id="splRate">
    </div>
  </div>
  <button onclick="addToCart()">➕ Add to Cart</button>
</div>
 

      <h3>🛒 Cart</h3>
      <div id="cart"></div>
      <button onclick="finalizeOrder()">📥 Finalise & Download PDF</button>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let stockData = [];
    let cart = [];
    let selectedProduct = null;

    document.getElementById("date").value = new Date().toISOString().split('T')[0];

    async function fetchExcel() {
      const response = await fetch("stock.xlsx");
      const blob = await response.blob();
      const data = await blob.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      json.forEach(row => {
        if (row[1] && row[13] && row[12] && row[10]) {
          stockData.push({
            brand: row[1],
            company: row[13],
            rate: row[12],
            mrp: row[10],
            stock: row[3]
          });
        }
      });
    }

    fetchExcel();

function nextScreen() {
  const s = document.getElementById("salesman").value;
  const p = document.getElementById("party").value;
  const pl = document.getElementById("place").value;

  if (!s || !p || !pl) {
    if (!confirm("Some fields are empty. Do you want to continue just to view prices?")) {
      return;
    }
  }

  document.getElementById("screen1").classList.remove("active");
  document.getElementById("screen2").classList.add("active");
}
    function filterProducts() {
      const input = document.getElementById("search").value.toLowerCase();
     const query = input.toLowerCase();
     const matches = stockData.filter(p => {
     const fullText = `${p.brand} ${p.company}`.toLowerCase();
      return fullText.includes(query);
});
      

      const container = document.getElementById("suggestions");
      container.innerHTML = "";
      matches.slice(0, 200).forEach(p => {
      const div = document.createElement("div");
      div.className = "product-card";
     div.innerHTML = `
    <span style="display:inline-block; min-width:300px; text-align:left;">
    ${p.brand} | ${p.company} | 
    <b style="color:red;">Rate: ${Number(p.rate).toFixed(2)}</b> | 
    <b style="color:blue;">MRP: ${Number(p.mrp).toFixed(2)}</b> | 
   <b style="color:green;">Stock: ${p.stock || "-"}</b>
    </span>
`;

div.onclick = () => {
  selectedProduct = p;
  document.getElementById("entryForm").style.display = "block";
  document.getElementById("rateInfo").innerHTML = `💰 <b>Rate:</b> ₹${p.rate} &nbsp;&nbsp; 🏷️ <b>MRP:</b> ₹${p.mrp}`;
  container.innerHTML = "";
  document.getElementById("search").value = `${p.brand} ${p.company}`;
};
        container.appendChild(div);
      });
    }

function addToCart() {
  try {
    // Basic validation
    if (!selectedProduct) {
      alert("Please select a product first.");
      return;
    }

    const qtyRaw = document.getElementById("qty").value;
    const qty = qtyRaw === "" ? "" : qtyRaw; // keep as string if empty or numeric string
    if (!qty) {
      // optional: require qty — if you want to allow blank qty remove this check
      if (!confirm("Quantity is empty. Add item with empty quantity?")) return;
    }

    const disc = document.getElementById("disc").value || "";
    const splRate = document.getElementById("splRate").value || "";

    // support both possible select ids: 'pack' or 'qtyType'
    const packEl = document.getElementById("pack") || document.getElementById("qtyType");
    const pack = packEl ? (packEl.value || "") : "";

    // push into cart (keep values as entered, no parsing)
    cart.push({
      ...selectedProduct,
      qty,
      pack,
      disc,
      splRate
    });

    // Reset UI
    document.getElementById("entryForm").style.display = "none";
    document.getElementById("qty").value = "";
    document.getElementById("disc").value = "";
    document.getElementById("splRate").value = "";
    if (packEl) packEl.value = packEl.querySelector("option") ? packEl.querySelector("option").value : "";
    document.getElementById("search").value = "";
    const suggestions = document.getElementById("suggestions");
    if (suggestions) suggestions.innerHTML = "";

    selectedProduct = null; // clear selection so user must choose next product explicitly
    renderCart();
  } catch (err) {
    console.error("addToCart error:", err);
    alert("Something went wrong while adding to cart. Open browser console for details.");
  }
}

    function renderCart() {
      const c = document.getElementById("cart");
      c.innerHTML = "";
      cart.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "product-card";
        div.innerHTML = `${index + 1}. ${item.brand} (${item.company}) - Qty: ${item.qty} ${item.qtyType || ''} | Rate: ₹${item.rate} | Spl: ₹${item.splRate || "-"} | Disc: ${item.disc || 0}% <span class='cart-item-actions'><button onclick='removeItem(${index})'>❌</button></span>`;
        c.appendChild(div);
      });
    }

    function removeItem(i) {
      cart.splice(i, 1);
      renderCart();
    }

async function finalizeOrder() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const date = document.getElementById("date").value;
  const salesman = document.getElementById("salesman").value;
  const party = document.getElementById("party").value;
  const place = document.getElementById("place").value;

  // Header
  doc.setFontSize(16);
  doc.text("Ishwar Pharma - Purchase Order", 14, 15);

  doc.setFontSize(12);
  doc.text(`Date: ${date}`, 14, 25);
  doc.text(`Salesman: ${salesman}`, 14, 32);
  doc.text(`Party: ${party}`, 14, 39);
  doc.text(`Place: ${place}`, 14, 46);

  // Table headings
  const headers = [["Sr", "Brand", "Company", "Qty", "Rate", "Special Rate", "Disc%"]];

// Table rows
const rows = cart.map((item, index) => [
  index + 1,
  item.brand || "",
  item.company || "",
  (item.qty || "") + " " + (item.pack || ""),
  item.rate ? Number(item.rate).toFixed(2) : "",
  item.splRate ? Number(item.splRate).toFixed(2) : "-",
  (item.disc || 0) + "%"
]);
  

  // Generate table
  doc.autoTable({
    head: headers,
    body: rows,
    startY: 55,
    styles: { fontSize: 10, halign: 'left', cellPadding: 2 },
    headStyles: { fillColor: [0, 102, 204], textColor: 255, fontStyle: 'bold' },
    columnStyles: {
      4: { textColor: [0, 0, 0], fontStyle: 'bold' }, // Rate
      5: { textColor: [255, 0, 0], fontStyle: 'bold' } // Special Rate in red
    }
  });

  doc.save("purchase_order.pdf");
}

  </script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

</body>

</html>


