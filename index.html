<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ishwar Pharma Order Form</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f2f9ff;
      padding: 16px;
      color: #333;
    }
    .container {
      max-width: 480px;
      margin: auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #0077cc;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 500;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }
    .hidden {
      display: none;
    }
    .emoji {
      font-size: 1.2rem;
      margin-right: 6px;
    }
    .product-card {
      background: #e6f2ff;
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
    }
    .button {
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      font-weight: bold;
      cursor: pointer;
    }
    .button:hover {
      background-color: #005fa3;
    }
  </style>
</head>
<body>
  <div class="container" id="welcomeScreen">
    <h2>üì¶ Ishwar Pharma Order Form</h2>
    <label>Date</label>
    <input type="text" id="orderDate" disabled />
    <label>üë§ Salesman Name</label>
    <input type="text" id="salesman" required />
    <label>üè™ Party Name</label>
    <input type="text" id="party" required />
    <label>üìç District/Place</label>
    <input type="text" id="place" required />
    <button class="button" onclick="goToOrderScreen()">üõí Start Ordering</button>
  </div>

  <div class="container hidden" id="orderScreen">
    <label>üîç Search Product (Brand Company)</label>
    <input type="text" id="search" placeholder="e.g. dolo intas" oninput="searchProduct()" />
    <select id="productList" onchange="selectProduct()"></select>
    <div id="productDetails" class="hidden">
      <label>üì¶ Quantity</label>
      <input type="number" id="qty" inputmode="numeric" />
      <label>üí∏ Normal Rate: <span id="rateShow"></span> | MRP: <span id="mrpShow"></span></label>
      <label>üî¢ Discount %</label>
      <input type="number" id="disc" inputmode="numeric" />
      <label>‚ú® Special Rate (if any)</label>
      <input type="number" id="splrate" inputmode="numeric" />
      <button class="button" onclick="addToCart()">‚ûï Add to Cart</button>
    </div>
    <div id="cart"></div>
    <button class="button" onclick="generatePDF()">üìÑ Finalise & Download Order</button>
  </div>

  <script>
    let stockData = [];
    let cart = [];
    let selectedProduct = {};

    document.getElementById("orderDate").value = new Date().toLocaleDateString();

    async function fetchExcel() {
      const response = await fetch("stock.xlsx");
      const arrayBuffer = await response.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: "array" });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      stockData = data.slice(1).map(row => ({
        brand: row[1],
        mrp: row[10],
        rate: row[12],
        company: row[13]
      })).filter(r => r.brand && r.company);
    }

    function goToOrderScreen() {
      if (!document.getElementById("salesman").value || !document.getElementById("party").value || !document.getElementById("place").value) {
        alert("Please fill all fields!");
        return;
      }
      document.getElementById("welcomeScreen").classList.add("hidden");
      document.getElementById("orderScreen").classList.remove("hidden");
    }

    function searchProduct() {
      const input = document.getElementById("search").value.toLowerCase();
      const [brandInput, companyInput] = input.split(" ");
      const results = stockData.filter(item =>
        (!brandInput || item.brand.toLowerCase().includes(brandInput)) &&
        (!companyInput || item.company.toLowerCase().includes(companyInput))
      );
      const list = document.getElementById("productList");
      list.innerHTML = '<option>Select Product</option>' + results.map(r =>
        `<option value="${r.brand}|${r.company}|${r.rate}|${r.mrp}">${r.brand} - ${r.company} (‚Çπ${r.rate}/‚Çπ${r.mrp})</option>`
      ).join("");
    }

    function selectProduct() {
      const value = document.getElementById("productList").value;
      if (value.includes("|")) {
        const [brand, company, rate, mrp] = value.split("|");
        selectedProduct = { brand, company, rate: parseFloat(rate), mrp: parseFloat(mrp) };
        document.getElementById("rateShow").innerText = rate;
        document.getElementById("mrpShow").innerText = mrp;
        document.getElementById("productDetails").classList.remove("hidden");
      }
    }

    function addToCart() {
      const qty = parseInt(document.getElementById("qty").value);
      const disc = parseFloat(document.getElementById("disc").value || 0);
      const splrate = parseFloat(document.getElementById("splrate").value || 0);
      if (!qty || qty <= 0) return alert("Enter valid quantity");
      const rate = splrate || selectedProduct.rate;
      const amt = qty * rate * (1 - disc / 100);
      cart.push({ ...selectedProduct, qty, rate, disc, splrate, amt });
      renderCart();
      document.getElementById("productDetails").classList.add("hidden");
      document.getElementById("productList").value = "";
      document.getElementById("search").value = "";
    }

    function renderCart() {
      let html = '<h3>üõí Items in Cart:</h3>';
      let total = 0;
      cart.forEach((item, idx) => {
        html += `<div class='product-card'>${item.brand} - ${item.company}<br>Qty: ${item.qty}, Rate: ‚Çπ${item.rate}, Disc: ${item.disc || 0}%, Spl: ‚Çπ${item.splrate || '-'}, Amt: ‚Çπ${item.amt.toFixed(2)}</div>`;
        total += item.amt;
      });
      html += `<h3>üí∞ Grand Total: ‚Çπ${total.toFixed(2)}</h3>`;
      document.getElementById("cart").innerHTML = html;
    }

    async function generatePDF() {
      const {{ jsPDF }} = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.text("üßæ Ishwar Pharma Order", 10, y); y += 10;
      doc.text("Date: " + document.getElementById("orderDate").value, 10, y); y += 10;
      doc.text("Salesman: " + document.getElementById("salesman").value, 10, y); y += 10;
      doc.text("Party: " + document.getElementById("party").value + " (" + document.getElementById("place").value + ")", 10, y); y += 10;
      doc.text("---------------------------------------", 10, y); y += 10;
      cart.forEach((item, idx) => {
        doc.text(`${idx + 1}. ${item.brand} (${item.company})`, 10, y); y += 7;
        doc.text(`Qty: ${item.qty} | Rate: ‚Çπ${item.rate} | Spl: ‚Çπ${item.splrate || '-'} | Disc: ${item.disc || 0}% | Amt: ‚Çπ${item.amt.toFixed(2)}`, 10, y); y += 10;
      });
      const total = cart.reduce((sum, i) => sum + i.amt, 0);
      doc.text("---------------------------------------", 10, y); y += 10;
      doc.text("Grand Total: ‚Çπ" + total.toFixed(2), 10, y);
      doc.save("order.pdf");
    }

    fetchExcel();
  </script>
</body>
</html>