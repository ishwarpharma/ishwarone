<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ishwar Pharma Order Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      background: #f0f8ff;
      color: #333;
    }
    h2 {
      color: #0066cc;
    }
    input, button, select {
      font-size: 1.1em;
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .hidden {
      display: none;
    }
    .product-item {
      border: 1px solid #ccc;
      margin-bottom: 5px;
      padding: 10px;
      background: #e6f7ff;
    }
    .cart-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .cart-table th, .cart-table td {
      border: 1px solid #999;
      padding: 8px;
      text-align: left;
    }
    .section {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="step1">
    <h2>Ishwar Pharma Order Form</h2>
    <label for="date">Date:</label>
    <input type="text" id="date" readonly />

    <label for="salesman">Salesman Name:</label>
    <input type="text" id="salesman" required />

    <label for="party">Party Name:</label>
    <input type="text" id="party" required />

    <label for="place">Place/District:</label>
    <input type="text" id="place" required />

    <button onclick="startOrder()">Start Order</button>
  </div>

  <div id="step2" class="hidden">
    <div class="section">
      <label for="search">Search Product (Brand Company):</label>
      <input type="text" id="search" placeholder="Start typing..." oninput="searchProduct()" />
      <div id="suggestions"></div>
    </div>

    <div id="orderForm" class="section hidden">
      <p><strong>Selected:</strong> <span id="selectedProduct"></span></p>
      <label for="qty">Quantity:</label>
      <input type="number" id="qty" inputmode="numeric" pattern="[0-9]*" />

      <p>Rate: ₹<span id="rate"></span> | MRP: ₹<span id="mrp"></span></p>

      <label for="discount">Discount %:</label>
      <input type="number" id="discount" inputmode="numeric" pattern="[0-9]*" />

      <label for="splrate">Special Rate (if any):</label>
      <input type="number" id="splrate" inputmode="decimal" pattern="[0-9.]*" />

      <button onclick="addToCart()">Add to Cart</button>
    </div>

    <div id="cart" class="section">
      <h3>Cart</h3>
      <table class="cart-table">
        <thead>
          <tr>
            <th>Brand</th>
            <th>Company</th>
            <th>Qty</th>
            <th>Rate</th>
            <th>Discount</th>
            <th>Spl Rate</th>
          </tr>
        </thead>
        <tbody id="cartItems"></tbody>
      </table>
    </div>

    <button onclick="finalizeOrder()">Finalize Order</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    document.getElementById("date").value = new Date().toISOString().slice(0, 10);

    let stockData = [];
    let selectedItem = null;
    let cart = [];

    function startOrder() {
      if (!document.getElementById("salesman").value || !document.getElementById("party").value) {
        alert("Please enter Salesman and Party name.");
        return;
      }
      document.getElementById("step1").classList.add("hidden");
      document.getElementById("step2").classList.remove("hidden");
    }

    fetch("stock.xlsx")
      .then(res => res.arrayBuffer())
      .then(ab => {
        const wb = XLSX.read(ab, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        data.slice(1).forEach(row => {
          stockData.push({
            brand: row[1],
            company: row[13],
            rate: row[12],
            mrp: row[10]
          });
        });
      });

    function searchProduct() {
      const keyword = document.getElementById("search").value.toLowerCase();
      const results = stockData.filter(item =>
        (item.brand + " " + item.company).toLowerCase().includes(keyword)
      ).slice(0, 10);

      const suggestions = results.map(item =>
        `<div class='product-item' onclick='selectProduct(${JSON.stringify(JSON.stringify(item))})'>
          ${item.brand} | ${item.company} | ₹${item.rate} | MRP ₹${item.mrp}
        </div>`
      ).join("");
      document.getElementById("suggestions").innerHTML = suggestions;
    }

    function selectProduct(jsonStr) {
      selectedItem = JSON.parse(JSON.parse(jsonStr));
      document.getElementById("selectedProduct").textContent = `${selectedItem.brand} - ${selectedItem.company}`;
      document.getElementById("rate").textContent = selectedItem.rate;
      document.getElementById("mrp").textContent = selectedItem.mrp;
      document.getElementById("orderForm").classList.remove("hidden");
    }

    function addToCart() {
      const qty = +document.getElementById("qty").value;
      const discount = +document.getElementById("discount").value;
      const splrate = +document.getElementById("splrate").value;

      if (!qty) return alert("Enter quantity");
      cart.push({
        ...selectedItem,
        qty,
        discount,
        splrate: splrate || "-"
      });

      document.getElementById("cartItems").innerHTML = cart.map(item =>
        `<tr>
          <td>${item.brand}</td>
          <td>${item.company}</td>
          <td>${item.qty}</td>
          <td>${item.rate}</td>
          <td>${item.discount}</td>
          <td>${item.splrate}</td>
        </tr>`
      ).join("");

      document.getElementById("orderForm").classList.add("hidden");
      document.getElementById("search").value = "";
      document.getElementById("suggestions").innerHTML = "";
    }

    function finalizeOrder() {
      alert("Final PDF generation coming next!");
      // Generate PDF here (can integrate jsPDF in next step)
    }
  </script>
</body>
</html>