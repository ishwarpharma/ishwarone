<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ishwar Pharma Order Form</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.0/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/whatsapp-web-api"></script>
  <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .hidden {
      display: none;
    }
    .cart-row {
      display: grid;
      grid-template-columns: 1fr 3fr 1fr 1fr 1fr 1fr 1fr 1fr;
      gap: 0.5rem;
      padding: 0.5rem;
      border-bottom: 1px solid #ccc;
      align-items: center;
    }
    .cart-header {
      font-weight: bold;
      background-color: #f3f4f6;
    }
  </style>
</head>
<body class="bg-gray-100 p-4">
  <div id="welcome-screen" class="text-center">
    <h1 class="text-3xl font-bold mb-4">üßæ Ishwar Pharma Order Form</h1>
    <div class="mb-4">
      <label class="block text-gray-700">Date</label>
      <input type="date" id="order-date" class="border p-2" value="" />
    </div>
    <div class="mb-4">
      <label class="block text-gray-700">Salesman Name</label>
      <input type="text" id="salesman" class="border p-2 w-full" placeholder="Enter salesman name" />
    </div>
    <div class="mb-4">
      <label class="block text-gray-700">Party Name</label>
      <input type="text" id="party" class="border p-2 w-full" placeholder="Enter party name" />
    </div>
    <div class="mb-4">
      <label class="block text-gray-700">Place</label>
      <input type="text" id="place" class="border p-2 w-full" placeholder="Enter place" />
    </div>
    <button onclick="startOrder()" class="bg-green-500 text-white px-6 py-2 rounded">üöÄ Start Ordering</button>
  </div>

  <div id="order-section" class="hidden">
    <div class="mb-4">
      <label class="block text-gray-700">Search Product</label>
      <input type="text" id="search" class="border p-2 w-full" placeholder="Type brand or 'brand company'" oninput="searchProduct()" />
      <ul id="search-results" class="bg-white shadow-md max-h-40 overflow-auto"></ul>
    </div>

    <div id="product-entry" class="hidden mb-4">
      <h2 class="text-xl font-bold mb-2">üì¶ Product Entry</h2>
      <p id="selected-product-info" class="mb-2 text-gray-700"></p>
      <label>Qty</label>
      <input type="number" id="qty" class="border p-2 mb-2 w-full" inputmode="numeric" />
      <label>Discount %</label>
      <input type="number" id="discount" class="border p-2 mb-2 w-full" inputmode="numeric" />
      <label>Special Rate</label>
      <input type="number" id="splrate" class="border p-2 mb-2 w-full" inputmode="numeric" />
      <button onclick="addToCart()" class="bg-blue-500 text-white px-4 py-2 rounded">‚ûï Add to Cart</button>
    </div>

    <div class="mt-6">
      <h2 class="text-xl font-bold">üõí Cart</h2>
      <div id="cart" class="bg-white p-4 shadow-md mt-2"></div>
      <button onclick="finalizeOrder()" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded">üì§ Finalize & Download PDF</button>
    </div>
  </div>

  <script>
    let stockData = [];
    let cart = [];
    let selectedProduct = null;

    document.getElementById('order-date').valueAsDate = new Date();

    async function loadStock() {
      const res = await fetch('stock.xlsx');
      const ab = await res.arrayBuffer();
      const wb = XLSX.read(ab, { type: 'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      stockData = XLSX.utils.sheet_to_json(sheet);
    }

    function startOrder() {
      document.getElementById('welcome-screen').classList.add('hidden');
      document.getElementById('order-section').classList.remove('hidden');
    }

    function searchProduct() {
      const query = document.getElementById('search').value.toLowerCase().split(' ');
      const [brand, company] = query;
      const results = stockData.filter(item =>
        item.Brand?.toLowerCase().includes(brand || '') &&
        item.Company?.toLowerCase().includes(company || brand || '')
      );
      const resultList = document.getElementById('search-results');
      resultList.innerHTML = '';
      results.forEach(r => {
        const li = document.createElement('li');
        li.textContent = `${r.Brand} (${r.Company})`;
        li.className = 'p-2 cursor-pointer hover:bg-gray-200';
        li.onclick = () => selectProduct(r);
        resultList.appendChild(li);
      });
    }

    function selectProduct(p) {
      selectedProduct = p;
      document.getElementById('search').value = '';
      document.getElementById('search-results').innerHTML = '';
      document.getElementById('selected-product-info').innerHTML = `Brand: <strong>${p.Brand}</strong>, Company: <strong>${p.Company}</strong><br>Rate: ‚Çπ${p.Rate} | MRP: ‚Çπ${p.MRP}`;
      document.getElementById('product-entry').classList.remove('hidden');
    }

    function addToCart() {
      const qty = parseFloat(document.getElementById('qty').value);
      const disc = parseFloat(document.getElementById('discount').value);
      const spl = parseFloat(document.getElementById('splrate').value);
      if (!selectedProduct || isNaN(qty)) return alert('Incomplete details');
      const amt = qty * (spl || selectedProduct.Rate) * (1 - (disc || 0) / 100);
      cart.push({ ...selectedProduct, qty, disc, spl, amt });
      document.getElementById('product-entry').classList.add('hidden');
      document.getElementById('qty').value = document.getElementById('discount').value = document.getElementById('splrate').value = '';
      renderCart();
    }

    function renderCart() {
      const div = document.getElementById('cart');
      div.innerHTML = '';
      if (cart.length === 0) return (div.textContent = 'Cart is empty');
      div.innerHTML = `
        <div class="cart-row cart-header">
          <div>#</div><div>Product</div><div>Qty</div><div>Rate</div><div>Spl</div><div>Disc%</div><div>Amt</div><div>Action</div>
        </div>`;
      cart.forEach((item, i) => {
        div.innerHTML += `
          <div class="cart-row">
            <div>${i + 1}</div>
            <div>${item.Brand} (${item.Company})</div>
            <div>${item.qty}</div>
            <div>${item.Rate}</div>
            <div>${item.spl || '-'}</div>
            <div>${item.disc || '-'}</div>
            <div>‚Çπ${item.amt.toFixed(2)}</div>
            <div><button onclick="removeItem(${i})" class="text-red-500">‚ùå</button></div>
          </div>`;
      });
    }

    function removeItem(index) {
      cart.splice(index, 1);
      renderCart();
    }

    function finalizeOrder() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.text(`Ishwar Pharma Order`, 10, y);
      y += 10;
      doc.text(`Date: ${document.getElementById('order-date').value}`, 10, y);
      y += 6;
      doc.text(`Salesman: ${document.getElementById('salesman').value}`, 10, y);
      y += 6;
      doc.text(`Party: ${document.getElementById('party').value}, Place: ${document.getElementById('place').value}`, 10, y);
      y += 10;
      doc.text('SNo  Item  Qty  Rate  Spl  Disc%  Amt', 10, y);
      y += 6;
      cart.forEach((item, i) => {
        doc.text(`${i + 1}. ${item.Brand} - ${item.qty} - ‚Çπ${item.Rate} - ‚Çπ${item.spl || '-'} - ${item.disc || 0}% - ‚Çπ${item.amt.toFixed(2)}`, 10, y);
        y += 6;
      });
      const total = cart.reduce((t, i) => t + i.amt, 0);
      doc.text(`Grand Total: ‚Çπ${total.toFixed(2)}`, 10, y + 6);
      doc.save('order.pdf');
    }

    loadStock();
  </script>
</body>
</html>