<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Order Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      background: #f0f8ff;
      color: #333;
    }
    h2, h3 {
      color: #0066cc;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    .cart-item {
      background: #e6f7ff;
      padding: 10px;
      margin-top: 10px;
      border-left: 4px solid #0099cc;
    }
    .btn {
      background: #0077cc;
      color: white;
      border: none;
      margin-top: 10px;
    }
    .btn:hover {
      background: #005fa3;
    }
    #orderSection {
      display: none;
    }
  </style>
</head>
<body>

  <div id="startSection">
    <h2>ğŸ“¦ Sales Order Form</h2>

    <label for="salesman">ğŸ‘¤ Salesman Name:</label>
    <input type="text" id="salesman" placeholder="Enter your name">

    <label for="party">ğŸª Party Name:</label>
    <input type="text" id="party" placeholder="Enter party name">

    <label for="district">ğŸ“ District:</label>
    <input type="text" id="district" placeholder="Enter district">

    <button class="btn" onclick="startOrder()">Start Order â¡ï¸</button>
  </div>

  <div id="orderSection">
    <label for="search">ğŸ” Search Product:</label>
    <input type="text" id="search" placeholder="Enter brand and company keywords">
    <select id="productDropdown"></select>

    <label for="qty">ğŸ”¢ Quantity:</label>
    <input type="number" id="qty" min="1">

    <label for="discount">ğŸ’¸ Discount %:</label>
    <input type="number" id="discount" min="0" max="100">

    <label for="splRate">â­ Special Rate (if any):</label>
    <input type="number" id="splRate">

    <button class="btn" onclick="addToCart()">Add to Cart ğŸ›’</button>

    <div id="cart"></div>

    <button class="btn" onclick="finalizeOrder()">ğŸ“„ Finalize Order & Download PDF</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let products = [];
    let cart = [];

    function startOrder() {
      const salesman = document.getElementById('salesman').value.trim();
      const party = document.getElementById('party').value.trim();
      const district = document.getElementById('district').value.trim();
      if (!salesman || !party || !district) {
        alert('Please fill all details');
        return;
      }
      document.getElementById('startSection').style.display = 'none';
      document.getElementById('orderSection').style.display = 'block';
    }

    // Load XLS and parse
    fetch('stock.xls')
      .then(response => response.arrayBuffer())
      .then(data => {
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        jsonData.forEach((row, i) => {
          if (i > 0 && row.length > 13) {
            products.push({
              brand: row[1],
              company: row[13],
              rate: parseFloat(row[12]) || 0,
              mrp: parseFloat(row[10]) || 0
            });
          }
        });
      });

    document.getElementById('search').addEventListener('input', function () {
      const keyword = this.value.toLowerCase();
      const dropdown = document.getElementById('productDropdown');
      dropdown.innerHTML = '';
      products.filter(p => `${p.brand} ${p.company}`.toLowerCase().includes(keyword))
        .forEach(p => {
          const option = document.createElement('option');
          option.value = `${p.brand} | ${p.company} | â‚¹${p.rate} | MRP â‚¹${p.mrp}`;
          option.dataset.brand = p.brand;
          option.dataset.company = p.company;
          option.dataset.rate = p.rate;
          option.dataset.mrp = p.mrp;
          dropdown.appendChild(option);
        });
    });

    function addToCart() {
      const selected = document.getElementById('productDropdown').selectedOptions[0];
      if (!selected) return;
      const qty = parseInt(document.getElementById('qty').value);
      const discount = parseFloat(document.getElementById('discount').value) || 0;
      const splRate = parseFloat(document.getElementById('splRate').value) || null;
      if (!qty) return;

      const item = {
        brand: selected.dataset.brand,
        company: selected.dataset.company,
        qty,
        rate: selected.dataset.rate,
        discount,
        splRate,
        mrp: selected.dataset.mrp
      };
      cart.push(item);
      displayCart();
    }

    function displayCart() {
      const cartDiv = document.getElementById('cart');
      cartDiv.innerHTML = '<h3>ğŸ›ï¸ Cart</h3>';
      cart.forEach((item, index) => {
        cartDiv.innerHTML += `<div class='cart-item'>${index + 1}. <strong>${item.brand}</strong> (${item.company}) - Qty: ${item.qty}, Rate: â‚¹${item.rate}, Disc: ${item.discount}%, Spl Rate: â‚¹${item.splRate || '-'} </div>`;
      });
    }

    function finalizeOrder() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const salesman = document.getElementById('salesman').value;
      const party = document.getElementById('party').value;
      const district = document.getElementById('district').value;

      doc.text(`Salesman: ${salesman}`, 10, 10);
      doc.text(`Party: ${party}`, 10, 20);
      doc.text(`District: ${district}`, 10, 30);

      let y = 50;
      cart.forEach((item, i) => {
        const total = (item.splRate || item.rate) * item.qty;
        doc.text(`${i + 1}) ${item.brand} (${item.company}) - Qty: ${item.qty}, Rate: â‚¹${item.rate}, Disc: ${item.discount}%, Spl Rate: â‚¹${item.splRate || '-'}, Total: â‚¹${total.toFixed(2)}`, 10, y);
        y += 10;
      });

      doc.save(`${party}_Order.pdf`);
    }
  </script>
</body>
</html>
