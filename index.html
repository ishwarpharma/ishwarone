<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ishwar Pharma Order Form</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f7f7f7; font-family: 'Segoe UI', sans-serif; }
    .container { max-width: 540px; margin-top: 2rem; }
    .section { display: none; }
    .visible { display: block; }
    #search-results { max-height: 200px; overflow-y: auto; }
    .cart-table td, .cart-table th { font-size: 0.9rem; padding: 4px; }
    .delete-btn { cursor: pointer; color: red; }
  </style>
</head>
<body>
<div class="container">
  <div id="welcome" class="section visible">
    <h3 class="text-center mb-4">ğŸ’Š Ishwar Pharma Order Form</h3>
    <div class="mb-3">
      <label class="form-label">Date</label>
      <input type="text" id="order-date" class="form-control" readonly />
    </div>
    <div class="mb-3">
      <label class="form-label">Salesman Name</label>
      <input type="text" id="salesman-name" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label">Party Name</label>
      <input type="text" id="party-name" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label">Place/District</label>
      <input type="text" id="district" class="form-control" required />
    </div>
    <button class="btn btn-primary w-100" onclick="startOrdering()">ğŸš€ Start Ordering</button>
  </div>

  <div id="ordering-section" class="section">
    <h5>ğŸ›’ Add Products</h5>
    <input type="text" id="product-search" class="form-control mb-2" placeholder="Search brand name & company name..." />
    <ul id="search-results" class="list-group mb-3"></ul>

    <div id="product-input-section" class="mb-3" style="display:none;">
      <p><strong id="selected-product"></strong></p>
      <p>ğŸ’µ Rate: â‚¹<span id="selected-rate"></span> | ğŸ·ï¸ MRP: â‚¹<span id="selected-mrp"></span></p>
      <input type="number" inputmode="numeric" id="qty" class="form-control mb-2" placeholder="Qty" />
      <input type="number" inputmode="numeric" id="disc" class="form-control mb-2" placeholder="Discount %" />
      <input type="number" inputmode="numeric" id="spl-rate" class="form-control mb-2" placeholder="Special Rate (if any)" />
      <button class="btn btn-success w-100" onclick="addToCart()">â• Add to Cart</button>
    </div>

    <hr />
    <h5>ğŸ§¾ Your Cart</h5>
    <table class="table table-bordered cart-table">
      <thead>
        <tr>
          <th>#</th><th>Product</th><th>Qty</th><th>Rate</th><th>Disc%</th><th>Spl Rate</th><th>Amt</th><th></th>
        </tr>
      </thead>
      <tbody id="cart-body"></tbody>
    </table>
    <p class="text-end fw-bold">Total: â‚¹<span id="grand-total">0</span></p>
    <button class="btn btn-dark w-100" onclick="downloadPDF()">ğŸ“„ Finalise & Download Order</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const products = [];
  const cart = [];
  let selectedItem = {};

  document.getElementById("order-date").value = new Date().toISOString().split('T')[0];

  async function fetchData() {
    const url = "https://ishwarpharma.github.io/ishwarone/stock.xlsx";
    const response = await fetch(url);
    const arrayBuffer = await response.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    products.push(...json);
  }

  fetchData();

  function startOrdering() {
    if (!document.getElementById('salesman-name').value || !document.getElementById('party-name').value || !document.getElementById('district').value) {
      alert("Please fill in all details"); return;
    }
    document.getElementById("welcome").classList.remove("visible");
    document.getElementById("ordering-section").classList.add("visible");
  }

  document.getElementById("product-search").addEventListener("input", function () {
    const val = this.value.toLowerCase().split(" ");
    const [brandKey, companyKey] = val;
    const matches = products.filter(p =>
      (!brandKey || (p["__EMPTY_1"] || "").toLowerCase().includes(brandKey)) &&
      (!companyKey || (p["__EMPTY_13"] || "").toLowerCase().includes(companyKey))
    );
    const resultsList = document.getElementById("search-results");
    resultsList.innerHTML = "";
    matches.slice(0, 20).forEach(p => {
      const li = document.createElement("li");
      li.className = "list-group-item list-group-item-action";
      li.textContent = `${p["__EMPTY_1"]} | ${p["__EMPTY_13"]} | â‚¹${p["__EMPTY_12"]} | MRP â‚¹${p["__EMPTY_10"]}`;
      li.onclick = () => showProductInput(p);
      resultsList.appendChild(li);
    });
  });

  function showProductInput(product) {
    selectedItem = product;
    document.getElementById("selected-product").textContent = `${product["__EMPTY_1"]} (${product["__EMPTY_13"]})`;
    document.getElementById("selected-rate").textContent = product["__EMPTY_12"];
    document.getElementById("selected-mrp").textContent = product["__EMPTY_10"];
    document.getElementById("product-input-section").style.display = "block";
    document.getElementById("product-search").value = "";
    document.getElementById("search-results").innerHTML = "";
  }

  function addToCart() {
    const qty = parseFloat(document.getElementById("qty").value) || 0;
    const disc = parseFloat(document.getElementById("disc").value) || 0;
    const splRate = parseFloat(document.getElementById("spl-rate").value) || 0;
    const rate = parseFloat(selectedItem["__EMPTY_12"]);
    const effectiveRate = splRate || rate * (1 - disc / 100);
    const amt = qty * effectiveRate;
    cart.push({
      name: selectedItem["__EMPTY_1"],
      company: selectedItem["__EMPTY_13"],
      rate, mrp: selectedItem["__EMPTY_10"],
      qty, disc, splRate, amt: amt.toFixed(2)
    });
    document.getElementById("product-input-section").style.display = "none";
    document.getElementById("qty").value = "";
    document.getElementById("disc").value = "";
    document.getElementById("spl-rate").value = "";
    renderCart();
  }

  function renderCart() {
    const body = document.getElementById("cart-body");
    body.innerHTML = "";
    let total = 0;
    cart.forEach((item, i) => {
      total += parseFloat(item.amt);
      body.innerHTML += `<tr><td>${i + 1}</td><td>${item.name}<br><small>${item.company}</small></td><td>${item.qty}</td><td>${item.rate}</td><td>${item.disc}</td><td>${item.splRate || "-"}</td><td>${item.amt}</td><td><span class='delete-btn' onclick='deleteItem(${i})'>âŒ</span></td></tr>`;
    });
    document.getElementById("grand-total").textContent = total.toFixed(2);
  }

  function deleteItem(i) {
    cart.splice(i, 1);
    renderCart();
  }

  async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const date = document.getElementById("order-date").value;
    const sales = document.getElementById("salesman-name").value;
    const party = document.getElementById("party-name").value;
    const district = document.getElementById("district").value;
    let y = 10;
    doc.setFontSize(12);
    doc.text("ğŸ§¾ Ishwar Pharma Order Summary", 10, y);
    y += 8;
    doc.text(`Date: ${date}`, 10, y);
    doc.text(`Salesman: ${sales}`, 100, y);
    y += 7;
    doc.text(`Party: ${party} (${district})`, 10, y);
    y += 8;

    doc.setFontSize(10);
    doc.text("S.No  Product  Company  Qty  Rate  Disc%  SplRate  Amount", 10, y);
    y += 5;
    cart.forEach((item, i) => {
      doc.text(`${i + 1}  ${item.name}  ${item.company}  ${item.qty}  ${item.rate}  ${item.disc}  ${item.splRate || "-"}  ${item.amt}`, 10, y);
      y += 6;
    });
    y += 5;
    doc.setFontSize(12);
    doc.text(`Grand Total: â‚¹${document.getElementById("grand-total").textContent}`, 10, y);
    doc.save(`Order_${party}_${date}.pdf`);
  }
</script>
</body>
</html>
